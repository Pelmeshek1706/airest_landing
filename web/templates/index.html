<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attention Bias Test</title>
<style>
 body {
  margin: 0;
  text-align: center;
  font-family: Arial, sans-serif;
  overflow: hidden;
 }

 #displayCanvas {
  border: 1px solid #ccc;
  width: 100vw;
  height: 100vh;
  margin: 0;
  box-sizing: border-box;
  display: block;
  cursor: none;
  background-color: #f0f0f0;
 }

 #slides {
  display:none;
  display:flex;
  width:100vw;
  height:100vh;
  justify-content:center;
  align-items:center;
}
 .slide-img {
  width:25vw;
  height:25vh;
  margin:0 2vw;
  object-fit:contain;
}
</style>
<script src="{{ url_for('static', filename='js/animations.js') }}" defer></script>
</head>
<body>
<div id="startScreen">
 <h1>Attention Bias Test</h1>
 <button id="beginBtn">Begin</button>
</div>
<canvas id="displayCanvas" style="display:none;"></canvas>

<div id="slides">
 <img id="imgLeft" class.slide-img" src="" alt="left">
 <img id="imgRight" class="slide-img" src="" alt="right">
</div>
<div id="thankYou" style="display:none;">
 <h2>Thank you for completing test</h2>
</div>
<script>
const beginBtn = document.getElementById('beginBtn');
const startScreen = document.getElementById('startScreen');
const canvas = document.getElementById('displayCanvas');
const slidesDiv = document.getElementById('slides');
const imgLeft = document.getElementById('imgLeft');
const imgRight = document.getElementById('imgRight');
const thankYou = document.getElementById('thankYou');

let pollTimeoutId = null;
let slideInterval = null;
let currentSlide = 0;
const TOTAL_SLIDES = 10;
const SLIDE_DURATION = 5000;

let isSpaceDown = false;
let calibrationActive = false;
let currentCalibrationInfo = null;


document.addEventListener('keydown', (event) => {
    if (calibrationActive && event.code === 'Space' && !event.repeat) {
        isSpaceDown = true;
        event.preventDefault();
    }
});
document.addEventListener('keyup', (event) => {
    if (calibrationActive && event.code === 'Space') {
        isSpaceDown = false;
    }
});

function pollCalibration() {
    if (!calibrationActive) return; // stop polling if not active

    const url = '/calibration_step?space_down=' + (isSpaceDown ? '1' : '0');
    
    fetch(url).then(r => r.json()).then(data => {
        if (data.status === 'not_calibrating' || data.status === 'error') {
            console.error("Calibration error or not active, stopping poll");
            calibrationActive = false;
            Animator.stop();
            return;
        }
        
        const prevInfo = currentCalibrationInfo;
        currentCalibrationInfo = data;
        
        const currentPhase = data.phase;
        const prevPhase = prevInfo ? prevInfo.phase : null;

        if (currentPhase !== prevPhase) {
            Animator.setPhase(currentPhase);
        }

        if (currentPhase === 'point_completed' && prevPhase !== 'point_completed') {
            const [x, y] = data.display_info.target_point;
            Animator.triggerCompletionEffect(x, y);
        }

        if (data.status === 'finished_all') {
            calibrationActive = false;
            Animator.stop();
            canvas.style.display='none';
            slidesDiv.style.display='flex';
            startSlides();
        }
    }).catch(err => {
        console.error("Polling failed:", err);
        calibrationActive = false;
        Animator.stop();
    }).finally(() => {
        // chain the next poll request
        if (calibrationActive) {
            pollTimeoutId = setTimeout(pollCalibration, 33);
        }
    });
}

function startSlides() {
    fetch('/start_slides');
    showSlide(0);
    slideInterval = setInterval(() => {
        currentSlide++;
        if (currentSlide >= TOTAL_SLIDES) {
            clearInterval(slideInterval);
            finishTest();
        } else {
            showSlide(currentSlide);
        }
    }, SLIDE_DURATION);
    recordGaze();
}

function showSlide(idx) {
    imgLeft.src = `/static/slides/slide${idx+1}_left.svg`;
    imgRight.src = `/static/slides/slide${idx+1}_right.svg`;
    fetch(`/set_slide/${idx}`);
}

function recordGaze() {
    if (!slideInterval) return;
    fetch(`/record_gaze?slide=${currentSlide}`);
    setTimeout(recordGaze, 100);
}

function finishTest() {
    slideInterval = null;
    slidesDiv.style.display='none';
    thankYou.style.display='block';
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    }
    fetch('/finish');
}

beginBtn.onclick = () => {
    const docEl = document.documentElement;
    const requestFS = docEl.requestFullscreen || docEl.webkitRequestFullscreen;
    let fsPromise = Promise.resolve();
    if (requestFS) {
        const result = requestFS.call(docEl);
        if (result && typeof result.then === 'function') fsPromise = result;
    }

    fsPromise.finally(() => {
        startScreen.style.display='none';
        canvas.style.display='block';
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        fetch('/start_test', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({width: window.innerWidth, height: window.innerHeight})
        }).then(() => {
            calibrationActive = true;
            
            Animator.init(canvas);
            Animator.run(() => {
                Animator.draw(currentCalibrationInfo);
            });
            
            // start the polling chain
            pollCalibration();
        });
    });
};
</script>
</body>
</html>