<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attention Bias Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin:0; overflow:hidden; }
    #displayCanvas {
      width:100vw; height:100vh; display:block;
      background:#f0f0f0; cursor:none;
    }
    #slides {
      display:flex; width:100vw; height:100vh;
      justify-content:center; align-items:center;
    }
    .slide-img { width:25vw; height:25vh; margin:0 2vw; object-fit:contain; }
  </style>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="{{ url_for('static', path='js/animations.js') }}" defer></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div id="startScreen" class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full">
    <h1 class="text-4xl font-extrabold text-gray-800 mb-6">AIREST</h1>
    <h2 class="text-2xl text-gray-800 mb-6">Attention Bias Test</h2>
    <button id="beginBtn"
            class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold py-3 px-8 rounded-2xl shadow-lg transform transition hover:scale-105">
      Почати тест
    </button>
  </div>

  <canvas id="displayCanvas" style="display:none;"></canvas>

  <div id="slides" style="display:none;">
    <img id="imgLeft" class="slide-img" src="" alt="left" />
    <img id="imgRight" class="slide-img" src="" alt="right" />
  </div>

  <div id="thankYou" class="hidden bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full">
    <h2 class="text-3xl font-bold text-gray-800 mb-4">Дякуємо за проходження тесту!</h2>
    <button id="restartBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-6 rounded-xl shadow transform transition hover:scale-105">
      На головну
    </button>
  </div>
<script>
const beginBtn = document.getElementById('beginBtn');
const startScreen = document.getElementById('startScreen');
const canvas = document.getElementById('displayCanvas');
const slidesDiv = document.getElementById('slides');
const imgLeft = document.getElementById('imgLeft');
const imgRight = document.getElementById('imgRight');
const thankYou = document.getElementById('thankYou');

let socket = null;
let slideInterval = null;
let currentSlide = 0;
let totalSlides = 10;
const SLIDE_DURATION = 5000;

let calibrationActive = false;
let currentCalibrationInfo = null;
let currentFPS = 0;

document.addEventListener('keydown', (event) => {
    if (calibrationActive && event.code === 'Space' && !event.repeat) {
        if(socket) socket.emit('user_input', { 'space_down': true });
        event.preventDefault();
    }
});
document.addEventListener('keyup', (event) => {
    if (calibrationActive && event.code === 'Space') {
        if(socket) socket.emit('user_input', { 'space_down': false });
    }
});

function setupSocketListeners() {
    socket.on('test_started', () => {
        console.log('Server confirmed test has started.');
    });

    socket.on('calibration_update', (data) => {
        const prevInfo = currentCalibrationInfo;
        currentCalibrationInfo = data;
        currentFPS = data.fps || 0;

        const currentPhase = data.phase;
        const prevPhase = prevInfo ? prevInfo.phase : null;

        if (currentPhase !== prevPhase) {
            Animator.setPhase(currentPhase);
        }

        if (currentPhase === 'point_completed' && prevPhase !== 'point_completed') {
            const [x, y] = data.display_info.target_point;
            Animator.triggerCompletionEffect(x, y);
        }

        if (data.status === 'finished_all') {
            calibrationActive = false;
            Animator.stop();
            socket.disconnect();
            canvas.style.display='none';
            slidesDiv.style.display='flex';
            startSlides();
        }
    });

    socket.on('calibration_error', (data) => {
        console.error('Calibration Error:', data.message);
        calibrationActive = false;
        Animator.stop();
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server.');
        calibrationActive = false;
    });
}

async function loadSlideCount() {
    try {
        const res = await fetch('/static/slides_config.json');
        const data = await res.json();
        totalSlides = data.total_slides || totalSlides;
    } catch (err) {
        console.error('Failed to load slide config', err);
    }
}

async function startSlides() {
    await loadSlideCount();
    fetch('/start_slides');
    showSlide(0);
    slideInterval = setInterval(() => {
        currentSlide++;
        if (currentSlide >= totalSlides) {
            clearInterval(slideInterval);
            finishTest();
        } else {
            showSlide(currentSlide);
        }
    }, SLIDE_DURATION);
    recordGaze();
}

function showSlide(idx) {
    imgLeft.src = `/static/slides/slide${idx+1}_left.svg`;
    imgRight.src = `/static/slides/slide${idx+1}_right.svg`;
    fetch(`/set_slide/${idx}`);
}

function recordGaze() {
    if (!slideInterval) return;
    fetch(`/record_gaze?slide=${currentSlide}`);
    setTimeout(recordGaze, 100);
}

function finishTest() {
    slideInterval = null;
    slidesDiv.style.display='none';
    thankYou.style.display='block';
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    }
    fetch('/finish');
}

beginBtn.onclick = () => {
    const docEl = document.documentElement;
    const requestFS = docEl.requestFullscreen || docEl.webkitRequestFullscreen;
    let fsPromise = Promise.resolve();
    if (requestFS) {
        const result = requestFS.call(docEl);
        if (result && typeof result.then === 'function') fsPromise = result;
    }

    fsPromise.finally(() => {
        startScreen.style.display='none';
        canvas.style.display='block';
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        socket = io();
        setupSocketListeners();
        
        socket.on('connect', () => {
            console.log('Connected to server, starting test.');
            calibrationActive = true;
            
            Animator.init(canvas);
            Animator.run(() => {
                Animator.draw(currentCalibrationInfo, currentFPS);
            });

            socket.emit('start_test', {
                width: window.innerWidth,
                height: window.innerHeight
            });
        });
    });
};
document.getElementById('restartBtn').onclick = () => {
    window.location.href = '/';
};
</script>
</body>
</html>